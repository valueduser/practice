name: Deploy to Railway

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set up Railway CLI
        uses: railwayapp/setup-railway@v1
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }} # Securely stored Railway API token

      - name: Deploy to Railway
        run: railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }} # Ensures CLI has token
          # If your railway.toml doesn't specify the project ID, or if you haven't linked the project locally:
          # RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          # If you want to target specific services (usually `railway up` from root handles all):
          # RAILWAY_SERVICE: "my-astro-service,my-pocketbase-service"

          # Environment variables needed by your Docker build process on Railway
          # (e.g., for `npm run build` inside Dockerfile) can be set here
          # or, more commonly, directly in the Railway service settings.
          # Example:
          # PUBLIC_POCKETBASE_URL: ${{ secrets.PUBLIC_POCKETBASE_URL_FOR_ASTRO_BUILD }}
          # CI: true # Often used by build tools
